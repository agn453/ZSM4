	cseg

	ext	BDOS,UCASE,ISDIG,ALNUM,PUTCH

MKFCB	macro
;
;	Create FCB from string.
;	On input HL points to string, DE to dest FCB
;
MKFCB:	push	bc		; save registers
	push	de
	push	hl
	call	GETDU		; get current drive and user number
	ld	(de),a		; store as default
	ld	a,(hl)		; get char
	call	UCASE
	sub	'A'		; check for possible drive name
	jr	c,MK2		; branch if not a letter
	cp	16
	jr	nc,MK3		; branch if not valid drive and not a number
	ld	c,a		; C = possible drive number
	inc	hl
	ld	a,(hl)		; get next char
	cp	':'		; colon?
	jr	z,MK1		; branch if yes, drive specified
	call	ISDIG		; number?
	dec	hl
	jr	nz,MK3		; branch if not
	inc	hl
MK1:	ld	a,(de)		; get FCB drive/user
	and	0Fh		; mask user number
	ld	b,a
	ld	a,c		; get drive number
	rla
	rla
	rla
	rla
	and	0F0h		; into upper bits
	or	b		; merge with user number
	ld	(de),a		; back into the FCB
MK2:	ld	a,(hl)		; get char
	call	ISDIG		; number?
	jr	nz,MK3		; jump if not
	call	getdec		; else convert to binary
	and	0Fh		; 0 to 15
	ld	b,a
	ld	a,(de)		; get FCB drive/user
	and	0F0h		; mask drive bits
	or	b		; merge with user number
	ld	(de),a		; back into the FCB
MK3:	inc	de		; point to file name field
	ld	a,(hl)
	cp	':'
	jr	nz,MK4
	inc	hl
MK4:	ld	b,8
MK5:	ld	a,(hl)		; get char
	call	ucase
	call	alnum		; alphanumeric?
	jr	nz,MK6		; jump if not
	ld	(de),a		; set up file name
	inc	hl
	inc	de
	djnz	MK5
MK6:	ld	a,b
	or	a
	jr	z,MK8
	ld	a,' '		; pad with spaces
MK7:	ld	(de),a
	inc	de
	djnz	MK7
MK8:	ld	a,(hl)
	cp	'.'		; test for extension separator
	jr	z,MK9
	call	alnum		; alphanumeric?
	jr	nz,MK9		; jump if not
	inc	hl
	jr	MK8
MK9:	ld	a,(hl)
	ld	b,3
	cp	'.'
	jr	nz,MK11
	inc	hl
MK10:	ld	a,(hl)
	call	ucase
	call	alnum		; alphanumeric?
	jr	nz,MK11		; jump if not
	ld	(de),a
	inc	hl
	inc	de
	djnz	MK10
MK11:	ld	a,b
	or	a
	jr	z,MK13
	ld	a,' '
MK12:	ld	(de),a
	inc	de
	djnz	MK12
MK13:	pop	hl
	pop	de
	pop	bc
	ret

; Get current drive and user

DFUSR:	db	0
DFDRV:	db	0		; !!unused

GETDU:	push	bc
	push	de
	push	hl
	ld	c,20h		; BDOS get current user
	ld	e,0FFh
	call	BDOS
	and	0Fh
	ld	(DFUSR),a
	ld	b,a
	push	bc
	ld	c,19h		; BDOS get current drive
	call	BDOS
	ld	(DFDRV),a	; !!unused
	rla
	rla
	rla
	rla
	and	0F0h		; drive on upper nibble
	pop	bc
	or	b		; user number on lower nibble
	pop	hl
	pop	de
	pop	bc
	ret

; Set user from du: byte

setusr:	push	bc
	push	de
	push	hl
	and	0Fh
	ld	e,a
	ld	a,(DFUSR)
	cp	e
	ld	a,e
	ld	(DFUSR),a
	ld	c,20h		; BDOS set user
	call	nz,BDOS
	xor	a
	pop	hl
	pop	de
	pop	bc
	ret

getdec:	push	bc
	ld	bc,0
L39B9:	ld	a,(hl)
	call	ISDIG		; digit?
	jr	nz,L39CD	; jump if not
	call	mul10
	ld	a,(hl)
	sub	'0'
	add	a,c
	ld	c,a
	jr	nc,L39CA
	inc	b
L39CA:	inc	hl
	jr	L39B9
L39CD:	ld	a,c
	pop	bc
	ret

mul10:	push	hl
	ld	h,b
	ld	l,c
	add	hl,hl
	push	hl
	add	hl,hl
	add	hl,hl
	pop	bc
	add	hl,bc
	ld	b,h
	ld	l,c
	pop	hl
	ret

adec:	push	hl
	ld	h,0
	ld	l,a
	call	hldec
	pop	hl
	ret

; Output HL as unsigned decimal number to console

hldec:	push	bc
	push	de
	push	hl
	ld	c,0
	ld	de,10000
	call	sbcnt
	ld	de,1000
	call	sbcnt
	ld	de,100
	call	sbcnt
	ld	de,10
	call	sbcnt
	ld	a,l
	or	'0'
	call	putch
	pop	hl
	pop	de
	pop	bc
	ret

sbcnt:	ld	b,0FFh
L3A0F:	inc	b
	or	a
	sbc	hl,de
	jr	nc,L3A0F
	add	hl,de
	ld	a,b
	or	a
	jr	nz,L3A1D
	ld	a,c
	or	a
	ret	z
L3A1D:	or	'0'
	ld	c,a
	call	putch
	ret
	PRFCB
	endm

PRFCB	macro
	local	L398B,L3996,L399D,L39A4,L39B1
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	;********************************************************
	ld	a,(hl)
	rra
	rra
	rra
	rra
	and	0Fh
	push	bc
	push	de
	push	hl
	add	a,'A'
	call	putch
	ld	a,(hl)
	and	0Fh
	call	adec
	ld	a,':'
	call	putch
	inc	hl
	ld	b,8
L398B:	ld	a,(hl)
	cp	' '
	jr	z,L3996
	call	putch
	inc	hl
	djnz	L398B
L3996:	ld	a,b
	or	a
	jr	z,L399D
	inc	hl
	djnz	L3996
L399D:	ld	a,'.'
	call	putch
	ld	b,3
L39A4:	ld	a,(hl)
	and	7Fh
	cp	' '
	jr	z,L39B1
	call	putch
	inc	hl
	djnz	L39A4
L39B1:	pop	hl
	pop	de
	pop	bc
	ret
	endm

	MKFCB
	PRFCB

	end
